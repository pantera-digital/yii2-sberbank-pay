# Yii2 Sberbank payment module

Модуль позволяет организовать прием платежей через шлюз Сбербанка на вашем yii2-проекте. Для понимания принципов осуществления платежей через шлюз Сбербанка, пожалуйста, ознакомьтесь с официальной документацией, которую высылает техподдержка Сбербанка при регистрации мерчанта в их системе. При возникновении вопросов - пишите на контактную почту компании Pantera Digital, указанную в профиле компании на Github. Также мы готовы доработать модуль для вас, с предложениями также пишите на почту.

### Установка через композер
```
composer require ykweb/yii2-sberbank-pay "@dev"
```

### Запустить миграции
```
php yii migrate --migrationPath=@ykweb/yii2/pay/sberbank/migrations
```

### Настройка, добавить в config/main.php

```
'modules' => [
    'sberbank' => [
        'class' => 'ykweb\yii2\pay\sberbank\Module',
        'components' => [
            'sberbank' => [
                'class' => ykweb\yii2\pay\sberbank\components\Sberbank::class,
                
                // время жизни инвойса в секундах (по умолчанию 20 минут - см. документацию Сбербанка)
                // в этом примере мы ставим время 1 неделю, т.е. в течение этого времени покупатель может
                // произвести оплату по выданной ему ссылке
                'sessionTimeoutSecs' => 60 * 60 * 24 * 7,
                
                // логин api мерчанта
                'login' => 'ваш логин',
                
                // пароль api мерчанта
                'password' => 'ваш пароль',
                
                // использовать тестовый режим (по умолчанию - нет)
                'testServer' => false,
            ],
        ],
        
        // страница вашего сайта с информацией об успешной оплате
        'successUrl' => '/paySuccess',
        
        // страница вашего сайта с информацией о НЕуспешной оплате
        'failUrl' => '/payFail',
        
        // обработчик, вызываемый по факту успешной оплаты
        'successCallback' => function($invoice) {
            // какая-то ваша логика, например
            $order = \your\models\Order::findOne($invoice->order_id);
            $client = $order->getClient();
            $client->sendEmail('Зачислена оплата по вашему заказу №' . $order->id);
            // .. и т.д.
        },

        // необязательный callback для генерации uniqid инвойса, необходим
        // в том случае, если по каким-то причинам используемый по умолчанию
        // формат `#invoice_id#-#timestamp#` вам не подходит
        'idGenerator' => function(Invoice $invoice, int $id) {
            // $id - это uniqid, сгенерированный по умолчанию
            // вместо него используем собственный алгоритм, например такой
            return '000-AAA-' . $invoice->id;
        },
    ],
]
```

### Создание заказа

В вашем контроллере после сохранения заказа, либо на событие создания заказа вам необходимо создать инвойс, передав в него номер и сумму вашего заказа:

```
// ...здесь какая-то ваша логика по сохранению заказа, например это объект $order

// создаем и сохраняем инвойс, передаем в него номер и сумму вашего заказа
$invoice = \ykweb\yii2\pay\sberbank\models\Invoice::addSberbank($order->id, $order->price);
```

Далее для перенаправления пользователя на шлюз оплаты Сбербанка вам нужно выдать пользователю ссылку (либо автоматически перенаправить его) на url:

```
\yii\helpers\Html::a('Оплатить заказ', ['/sberbank/default/create', 'id' => $invoice->id /* id инвойса */])
```

При этом при переходе пользователя по этой ссылке (либо автоматическом перенаправлении) будет произведено обращение к API сбербанка для создания инвойса у них в системе, и перенаправление уже на платежную форму Сбербанка.

После успешной оплаты на шлюзе Сбербанка пользователь будет преренаправлен на `yoursite.com/paySuccess`. В случае неуспешной оплаты пользователь будет преренаправлен на `yoursite.com/payFail`. `paySuccess` и `payFail` задаются в настройках модуля, см. пример конфигурации.

### Статусы инвойсов
```
I - initial, инвойс создан
S - success, успешно оплачен
```
